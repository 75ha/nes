<!DOCTYPE html>  <html> <head>   <title>nes.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="nes.html">                 nes.js               </a>                                           <a class="source" href="extend_combo.html">                 extend_combo.js               </a>                                           <a class="source" href="extend_operator.html">                 extend_operator.js               </a>                                           <a class="source" href="extend_pesudo.html">                 extend_pesudo.js               </a>                                           <a class="source" href="extend_rule.html">                 extend_rule.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               nes.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="o">!</span><span class="kd">function</span><span class="p">(</span><span class="nx">win</span><span class="p">,</span> <span class="nx">doc</span><span class="p">){</span>

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>简介</h2>

<p>源码重构了两次，现在除了一两个主处理函数，所有函数都低于20行
完全的<strong>面向过程</strong>编程，不喜勿喷，通常你可以在调用函数的附近找到被调用函数
整个实现过程你可以找到一点点解析生成的感觉，因为整个选择器都是动态的
连parser也是</p>             </td>             <td class="code">               <div class="highlight"><pre>
  
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><strong>nes</strong>: 命名空间
本来想做个Wrapper类(类JQeruy)，想想还是做个纯粹的选择器吧
nes目前仅作为all方法的alias</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">nes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span><span class="k">return</span> <span class="nx">nes</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">)},</span>
    <span class="nx">prevNes</span> <span class="o">=</span> <span class="nx">win</span><span class="p">.</span><span class="nx">nes</span>

  <span class="nx">nes</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s2">&quot;0.0.3&quot;</span>

  <span class="kd">var</span> 
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>常用属性local化</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">ap</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">op</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">sp</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">fp</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">slice</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span>
    <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Helper(助手函数)</h3>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>够用的短小类型判断 </p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">typeOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">?</span> <span class="nb">String</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">:</span> 
                <span class="nx">op</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>够用的简单对象扩展</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o1</span><span class="p">,</span> <span class="nx">o2</span><span class="p">,</span> <span class="nx">override</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">o2</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">o1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">override</span><span class="p">)</span> <span class="nx">o1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>将类数组(如Nodelist、Argument)变为数组</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>让setter型函数fn支持object型的参数 
即支持<code>set(name:value)</code> 
也支持<code>set({name1:value1,name2:value2})</code></p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">autoSet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">key</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>先进先出缓存队列, max设置最大缓存长度, 为了不必要重复parse
nes会多次用到这个方法创建cache</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">createCache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">max</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="nx">set</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span> <span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
              <span class="k">delete</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]</span>
            <span class="p">}</span>
            <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
            <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">value</span>
          <span class="p">},</span>
          <span class="nx">get</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cache</span>
            <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>这个方法返回的对象有length属性，
你可以通过设置这个length后续调整缓存大小</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="nx">length</span><span class="o">:</span><span class="nx">max</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Fixed: toArray 低于IE8的 Nodelist无法使用slice获得array</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">try</span><span class="p">{</span>
    <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">))</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span><span class="nx">len</span><span class="o">=</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span>
    <span class="p">}</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>扩展ES5 Native支持的函数，坑爹的远古浏览器</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>es5 trim</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">trimReg</span> <span class="o">=</span> <span class="sr">/^\s+|\s+$/g</span>
  <span class="nx">sp</span><span class="p">.</span><span class="nx">trim</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">trim</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">trimReg</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>es5 bind</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">fp</span><span class="p">.</span><span class="nx">bind</span> <span class="o">=</span> <span class="nx">fp</span><span class="p">.</span><span class="nx">bind</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>es5 Array indexOf</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">ap</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">return</span> <span class="nx">i</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
  <span class="p">}</span> 

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Parse 开始</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>与parse部分关系紧密的属性在这里定义,
首先是一些parse会用到的但是不是语法组成部分的RegExp，</p>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="kd">var</span> 
    <span class="nx">replaceReg</span> <span class="o">=</span> <span class="sr">/\{\{([^\}]*)\}\}/g</span><span class="p">,</span> <span class="c1">//替换rule中的macro</span>
    <span class="nx">esReg</span> <span class="o">=</span> <span class="sr">/[-[\]{}()*+?.\\^$|,#\s]/g</span><span class="p">,</span> <span class="c1">//需转移字符</span>
    <span class="nx">nthReg</span> <span class="o">=</span> <span class="sr">/^nth-[\w-]+$/</span><span class="p">,</span>
    <span class="nx">nthValueReg</span> <span class="o">=</span> <span class="sr">/^(?:(\d+)|([+-]?\d*)?n([+-]\d+)?)$/</span><span class="p">,</span><span class="c1">// nth伪类的value规则</span>
    <span class="nx">posPesudoReg</span> <span class="o">=</span>  <span class="sr">/^(nth-)?[\w-]*(-of-type|-child)/</span> <span class="c1">//判断需要pos</span>

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>TRUNK</h3>

<p>所有的语法最后都会组装到这个TRUNK变成一个巨型RegExp  </p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">TRUNK</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> 

</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>第一个cache 用来装载nth伪类中的参数解析后的数据
如nth-child、nth-of-type等8个伪类</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">nthCache</span> <span class="o">=</span> <span class="nx">createCache</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>提取nthValue中的有用信息 比如an + b 我们需要提取出a以及b并对额外情况如缺少a参数或b参数
或者有a、b小于0这些情况作统一处理，返回find适合使用的数据</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">extractNthValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">){</span>
     <span class="kd">var</span> <span class="nx">step</span><span class="p">,</span><span class="nx">start</span><span class="p">,</span><span class="nx">res</span>
</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>如果无参数 当成是获取第一个元素</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">param</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">param</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))){</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">step</span><span class="o">:</span><span class="mi">0</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">nthCache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">param</span><span class="p">))</span> <span class="k">return</span> <span class="nx">res</span>
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>对even odd等转化为标准的a，b组合(即step与start)</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span><span class="p">(</span><span class="nx">param</span> <span class="o">==</span> <span class="s2">&quot;even&quot;</span><span class="p">){</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">param</span> <span class="o">==</span> <span class="s2">&quot;odd&quot;</span><span class="p">){</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">nthValueReg</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>对错误的nth参数抛出错误</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;错误的nth-child格式&quot;</span><span class="o">+</span><span class="nx">param</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]){</span>
          <span class="nx">step</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="nx">start</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="nx">step</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span><span class="mi">1</span>
          <span class="nx">start</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">:</span><span class="mi">0</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">start</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">step</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;an+b中的a，b不能同时都小于1&quot;</span><span class="p">)</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nx">start</span><span class="p">)</span><span class="o">%</span><span class="nx">step</span> <span class="o">+</span><span class="nx">step</span>
      <span class="p">}</span> 
      <span class="k">return</span> <span class="nx">nthCache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">param</span><span class="p">,{</span><span class="nx">start</span><span class="o">:</span><span class="nx">start</span><span class="p">,</span><span class="nx">step</span><span class="o">:</span><span class="nx">step</span><span class="p">})</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h3>parse Rule 相关</h3>

<p>了解bison等解析生成的同学可以把这部分看成是词法与语法定义的杂糅
很混乱不标准，但对于选择器这种最简单的DSL其实并不难懂
整个Parser根据rules动态产生(即可在使用时发生改变)</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>具体的流程是下面的rules对象定义了一组语法(词法?)rule——如attribute，
你可以把每个rule中的reg想象成一个token(word?),这些token可能会有{{word}}这种占位符
占位符首先会被macros中对应的macro替换，然后这些token会被组装成一个大版的Regexp，即上面的
Trunk变量,这个过程没什么特殊，一般比较优秀的选择器都是基于这个方法。 在nes中,最终的Trunk可能是
这样的:</p>

<p><code>/(\s*,\s*)|(#([\w\u4e00-\u9fbf-]+))|(\*|\w+)|(\.([\w\u4e00-\u9fbf-]+))|
(:([\w\u4e00-\u9fbf-]+)(?:\(([^\(\)]*|(?:\([^\)]+\)|[^\(\)]*)+)\))?)|
(\[([\w\u4e00-\u9fbf-]+)(?:([*^$|~!]?=)['"]?((?:[\w\u4e00-\u9fbf-]||\s)+)['"]?)?\])|(::([\w\u4e00-\u9fbf-]+))
|([&gt;\s+~&amp;%](?!=))|(\s*\{\s*(\d*),(\-?\d*)\s*\}\s*)/g</code></p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> 
</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>一些macro</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">macros</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">split</span><span class="o">:</span><span class="s2">&quot;\\s*,\\s*&quot;</span><span class="p">,</span> <span class="c1">// 分隔符</span>
      <span class="nx">operator</span><span class="o">:</span> <span class="s2">&quot;[*^$|~]?=&quot;</span><span class="p">,</span> <span class="c1">// 属性操作符 如= 、!=</span>
      <span class="nx">combo</span><span class="o">:</span> <span class="s2">&quot;[&gt;\\s+~](?!=)&quot;</span><span class="p">,</span> <span class="c1">// 连接符 如 &gt; ~ </span>
</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>中文unicode范围http://baike.baidu.com/view/40801.htm#sub40801_3</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">word</span><span class="o">:</span> <span class="s2">&quot;[\\w\\u4e00-\\u9fbf-]&quot;</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>语法规则定义</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">rules</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">split</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;{{split}}&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="kc">null</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">id</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;#({{word}}+)&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">tag</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;\\*|\\w+&quot;</span><span class="p">,</span><span class="c1">// 单纯的添加到</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">tag</span> <span class="o">=</span> <span class="nx">all</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">classList</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;\\.({{word}}+)&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span><span class="nx">className</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
            <span class="nx">classList</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">classList</span> <span class="o">||</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">classList</span> <span class="o">=</span> <span class="p">[])</span>
          <span class="nx">classList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">pesudos</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;:({{word}}+)&quot;</span> <span class="o">+</span>                 <span class="c1">//伪类名</span>
          <span class="s2">&quot;(?:\\(&quot;</span><span class="o">+</span>                  <span class="c1">//括号开始</span>
            <span class="s2">&quot;([^\\(\\)]*&quot;</span> <span class="o">+</span>      <span class="c1">//第一种无括号</span>
            <span class="s2">&quot;|(?:&quot;</span> <span class="o">+</span>                  <span class="c1">//有括号(即伪类中仍有伪类并且是带括号的)</span>
              <span class="s2">&quot;\\([^\\)]+\\)&quot;</span> <span class="o">+</span>             <span class="c1">//括号部分</span>
              <span class="s2">&quot;|[^\\(\\)]*&quot;</span> <span class="o">+</span>              
            <span class="s2">&quot;)+)&quot;</span> <span class="o">+</span>                    <span class="c1">//关闭有括号</span>
          <span class="s2">&quot;\\))?&quot;</span><span class="p">,</span>                   <span class="c1">// 关闭最外圈括号</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span><span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
          <span class="nx">pesudos</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">pesudos</span> <span class="o">||</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">pesudos</span> <span class="o">=</span> <span class="p">[])</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">nthReg</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)){</span>
</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>parse 的成本是很小的 尽量在find前把信息准备好
这里我们会把nth-child(an+b) 的 a 与 b 在不同输入下标准化</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">param</span> <span class="o">=</span> <span class="nx">extractNthValue</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> 
          <span class="p">}</span>
          <span class="nx">pesudos</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span><span class="nx">name</span><span class="p">,</span><span class="nx">param</span><span class="o">:</span><span class="nx">param</span><span class="p">})</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">attributes</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;\\[({{word}}+)(?:({{operator}})[\&#39;\&quot;]?((?:{{word}}||\\s)+)[\&#39;\&quot;]?)?\\]&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">operator</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
          <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="p">[])</span>
          <span class="nx">attributes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="nx">key</span><span class="p">,</span><span class="nx">operator</span><span class="o">:</span><span class="nx">operator</span><span class="p">,</span><span class="nx">value</span><span class="o">:</span><span class="nx">value</span><span class="p">})</span>
        <span class="p">}</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>伪元素可以实现么？ 占位</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">pesudoElements</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;::({{word}}+)&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">){}</span>
      <span class="p">},</span>
      <span class="nx">combo</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span><span class="s2">&quot;{{combo}}&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span>
            <span class="nx">cur</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">combo</span> <span class="o">=</span> <span class="nx">all</span>
          <span class="nx">cur</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">links</span><span class="o">=</span><span class="p">{}</span> <span class="c1">// symbol link 当setup之后会产生一个map来实现exec之后的参数对应</span>

</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>分析出regexp中的子匹配数</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">ignoredReg</span> <span class="o">=</span> <span class="sr">/\(\?\!|\(\?\:/</span>
  <span class="kd">var</span> <span class="nx">extractReg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">regStr</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">ignored</span> <span class="o">=</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\(\?\!|\(\?\:/</span><span class="p">).</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="c1">//忽略非捕获匹配</span>

    <span class="k">for</span><span class="p">(;</span><span class="nx">len</span><span class="o">--</span><span class="p">;){</span>
      <span class="kd">var</span> <span class="nx">letter</span> <span class="o">=</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">len</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">len</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">!==</span><span class="s2">&quot;\\&quot;</span><span class="p">){</span> <span class="c1">//不包括转义括号</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">letter</span> <span class="o">===</span> <span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="nx">left</span><span class="o">++</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">letter</span> <span class="o">===</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="nx">right</span><span class="o">++</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">left</span> <span class="o">!==</span> <span class="nx">right</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">regStr</span><span class="o">+</span><span class="s2">&quot;中的括号不匹配&quot;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nx">left</span> <span class="o">-</span> <span class="nx">ignored</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>这里替换掉Rule中的macro</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">cleanRule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rule</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">reg</span>
</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>如果已经是regexp了就转为string</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span><span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">reg</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;regexp&quot;</span><span class="p">)</span> <span class="nx">reg</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>将macro替换</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">replaceReg</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span> <span class="p">,</span><span class="nx">b</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="k">in</span> <span class="nx">macros</span><span class="p">)</span> <span class="k">return</span> <span class="nx">macros</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;can&quot;t replace undefined macros:&#39;</span> <span class="o">+</span><span class="nx">b</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">rule</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">cleanRules</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rules</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">rules</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="nx">cleanRule</span><span class="p">(</span><span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rules</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h2>API: 1. addRule         </h2>

<p>自定义规则, 增加全新语法
<strong>options:</strong>
1. name{string} 虽然可以随机生成，但是为了可维护起见，我改成了必须实名
2. rule 规则对象它包括
   * reg{string|regexp}:    规则的标准RegExp表达 <strong>不可忽略</strong>
   * action: parse时的动作 参数与<strong>reg</strong>相关(exec后的匹配) <strong>可忽略</strong>
   * filter: find时的过滤操作 参数与<strong>action</strong>有关 <strong>可忽略</strong></p>

<p>具体例子可以参考上方的rules对象,需要说明的是action回调中的this对象指向parsed
data对象,而filter中的node参数为当前遍历到的node</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">addRule</span> <span class="o">=</span> <span class="nx">addRule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">rule</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">name</span><span class="p">){</span>
        <span class="nx">addRule</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">name</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">rules</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;addRule失败:已有相同规则名存在:&quot;</span><span class="o">+</span><span class="nx">name</span><span class="p">)</span>
      <span class="nx">rules</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rule</span>
    <span class="p">}</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="c1">//每次添加新规则后都重新组装一边</span>
    <span class="k">return</span> <span class="nx">name</span> <span class="c1">//返回name</span>
  <span class="p">},</span>
  <span class="nx">setupOneRule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rule</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">splits</span><span class="p">,</span><span class="nx">curIndex</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">retain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">regexp</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span><span class="p">,</span>
      <span class="nx">filter</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span>
      <span class="nx">retain</span> <span class="o">=</span> <span class="nx">extractReg</span><span class="p">(</span><span class="nx">regexp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="c1">// 需要保留的参数</span>
    <span class="nx">links</span><span class="p">[</span><span class="nx">curIndex</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">index</span><span class="p">,</span><span class="nx">retain</span><span class="p">]</span> <span class="c1">//分别是rule名，参数数量</span>
    <span class="nx">curIndex</span> <span class="o">+=</span> <span class="nx">retain</span>
    <span class="nx">splits</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">regexp</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">filter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">filters</span><span class="p">[</span><span class="nx">i</span><span class="p">]){</span>
      <span class="nx">filters</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">filter</span> <span class="c1">//将filter转移到filters下</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">curIndex</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>组装</h2>

<p>组装处理三件事:
1. 生成symbol link 生成exec结果与action参数的对应
2. 替换{}占位符，并生成Big Trunk
3. 生成默认 action</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">setup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">curIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">//当前下标</span>
      <span class="nx">splits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">cleanRules</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">rules</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)){</span><span class="c1">// 这里把combo放置到最后</span>
        <span class="nx">curIndex</span> <span class="o">=</span> <span class="nx">setupOneRule</span><span class="p">(</span><span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span><span class="nx">splits</span><span class="p">,</span> <span class="nx">curIndex</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">TRUNK</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nx">splits</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;)|(&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">TRUNK</span><span class="p">)</span>
    <span class="nx">cleanReg</span> <span class="o">=</span> <span class="nx">cleanReg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;\\s*(,|&quot;</span> <span class="o">+</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">combo</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">operator</span> <span class="o">+</span> <span class="s2">&quot;)\\s*&quot;</span><span class="p">,</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  
</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>   parse主逻辑</h2>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> 
    <span class="nx">cleanReg</span><span class="p">,</span><span class="c1">//这个在组装时候完成</span>
    <span class="nx">clean</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cleanReg</span><span class="p">,</span><span class="s2">&quot;$1&quot;</span><span class="p">)</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h2>Process:处理每次匹配的函数</h2>

<ol>
<li>根据symbol link 散布参数</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">ruleName</span><span class="p">,</span> <span class="nx">link</span><span class="p">,</span> <span class="nx">rule</span><span class="p">,</span> <span class="nx">index</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">links</span><span class="p">){</span>
          <span class="nx">link</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="nx">ruleName</span> <span class="o">=</span> <span class="nx">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nx">retain</span> <span class="o">=</span><span class="nx">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="nx">index</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> 
          <span class="k">if</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">ruleName</span><span class="p">])){</span>
            <span class="nx">rule</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="nx">index</span><span class="o">+</span><span class="nx">retain</span><span class="p">))</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">parseCache</span> <span class="o">=</span> <span class="nx">createCache</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">){</span>
    
    <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">clean</span><span class="p">(</span><span class="nx">sl</span><span class="p">),</span><span class="nx">parsed</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">parsed</span> <span class="o">=</span> <span class="nx">parseCache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">selector</span><span class="p">))</span> <span class="k">return</span> <span class="nx">parsed</span>

    <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">null</span><span class="p">]],</span>
      <span class="nx">part</span>

    <span class="nx">parsed</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;选择符\&quot;&quot;</span> <span class="o">+</span> <span class="nx">selector</span> <span class="o">+</span> <span class="s2">&quot;\&quot;在(pos:&quot;</span> <span class="o">+</span>
        <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">lastMatch</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;):&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">msg</span><span class="o">||</span><span class="s2">&quot;Parse Error&quot;</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nx">parsed</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">piece</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">piece</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">return</span> <span class="nx">piece</span><span class="p">[</span><span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">piece</span><span class="p">[</span><span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">tag</span><span class="o">:</span><span class="s2">&quot;*&quot;</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">part</span> <span class="o">=</span> <span class="nx">TRUNK</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">selector</span><span class="p">)){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">lastMatch</span><span class="o">&amp;&amp;</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">lastMatch</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">index</span> <span class="o">!==</span> <span class="nx">part</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Syntax Error——有未识别语法&quot;</span><span class="p">)</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">part</span><span class="p">.</span><span class="nx">index</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">lastMatch</span> <span class="o">=</span> <span class="nx">part</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">parsed</span><span class="p">,</span><span class="nx">part</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">lastMatch</span><span class="o">&amp;&amp;</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">lastMatch</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">index</span> <span class="o">!==</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Syntax Error——有未识别语法&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">parseCache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">parsed</span><span class="p">)</span>
  <span class="p">}</span>
  
</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h1>  3. Finder</h1>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h2>  Util</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>将nodelist转变为array</p>             </td>             <td class="code">               <div class="highlight"><pre>
  
</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h2> DOM related Util</h2>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="kd">var</span>
    <span class="nx">root</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">documentElement</span><span class="o">||</span> <span class="nx">doc</span><span class="p">,</span>
    <span class="nx">attrMap</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;class&quot;</span> <span class="o">:</span> <span class="s2">&quot;className&quot;</span><span class="p">,</span>
      <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span>
      <span class="s2">&quot;checked&quot;</span><span class="o">:</span> <span class="s2">&quot;checked&quot;</span><span class="p">,</span>
      <span class="s2">&quot;disabled&quot;</span><span class="o">:</span> <span class="s2">&quot;disabled&quot;</span><span class="p">,</span>
      <span class="s2">&quot;href&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
        <span class="k">return</span> <span class="s2">&quot;href&quot;</span> <span class="k">in</span> <span class="nx">node</span><span class="o">?</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">:</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">},</span>
  
    <span class="nx">nthChild</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span> 
      <span class="k">if</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">type</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">nthLastChild</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">lastChild</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span> 
      <span class="k">if</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">type</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">nthPrev</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">){</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">)){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">type</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">node</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>向后查找n个节点元素</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">nthNext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">){</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">type</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">n</span><span class="o">--</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">node</span>
    <span class="p">},</span>
    <span class="nx">hasAttribute</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="p">}</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span>
    <span class="p">},</span>
    <span class="nx">getAttribute</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">attrMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="k">return</span> <span class="nx">node</span><span class="p">[</span><span class="nx">map</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>数组去重</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">distinct</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>先排除 即 如果它是清白的 后面就没有等值元素</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">array</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//不清白</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span> <span class="c1">//不清白</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">array</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>从sly(修改自sizzle) 抄袭的 document sorter 
将匹配元素集按文档顺序排列好 这很重要!</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">sortor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">)</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">:</span> <span class="p">(</span><span class="s1">&#39;sourceIndex&#39;</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">)</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">sourceIndex</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sourceIndex</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">:</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">createRange</span><span class="p">)</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">aRange</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createRange</span><span class="p">(),</span> <span class="nx">bRange</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();</span>
      <span class="nx">aRange</span><span class="p">.</span><span class="nx">setStart</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">aRange</span><span class="p">.</span><span class="nx">setEnd</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">bRange</span><span class="p">.</span><span class="nx">setStart</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">bRange</span><span class="p">.</span><span class="nx">setEnd</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">aRange</span><span class="p">.</span><span class="nx">compareBoundaryPoints</span><span class="p">(</span><span class="nx">Range</span><span class="p">.</span><span class="nx">START_TO_END</span><span class="p">,</span> <span class="nx">bRange</span><span class="p">);</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>获得node的唯一标示</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">getUid</span> <span class="o">=</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">_uid</span> <span class="o">=</span> <span class="mi">0</span> 
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_uid</span> <span class="o">||</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">_uid</span> <span class="o">=</span> <span class="nx">token</span> <span class="o">+</span> <span class="nx">_uid</span><span class="o">++</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})(</span><span class="s2">&quot;nes_&quot;</span><span class="o">+</span><span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">)),</span>
    <span class="nx">createNthFilter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isNext</span><span class="p">,</span> <span class="nx">isType</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">getStart</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">isNext</span><span class="p">){</span>
        <span class="nx">cache</span> <span class="o">=</span> <span class="nx">nthPositionCache</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="p">(</span><span class="nx">isType</span><span class="o">?</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;child&quot;</span><span class="p">)]</span>
        <span class="nx">next</span> <span class="o">=</span> <span class="nx">nthNext</span>
        <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span>
        <span class="nx">getStart</span> <span class="o">=</span> <span class="nx">nthChild</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">cache</span> <span class="o">=</span> <span class="nx">nthPositionCache</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="o">+</span><span class="p">(</span><span class="nx">isType</span><span class="o">?</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;child&quot;</span><span class="p">)]</span>
        <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthNext</span>
        <span class="nx">next</span> <span class="o">=</span> <span class="nx">nthPrev</span>
        <span class="nx">getStart</span> <span class="o">=</span> <span class="nx">nthLastChild</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">param</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">_uid</span> <span class="o">=</span> <span class="nx">getUid</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span>
          <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
          <span class="nx">traverse</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">?</span> <span class="nx">next</span> <span class="o">:</span> <span class="nx">prev</span><span class="p">,</span>
          <span class="nx">step</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">step</span><span class="p">,</span>
          <span class="nx">start</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">start</span> <span class="p">,</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">isType</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">[</span><span class="nx">_uid</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">nes</span><span class="p">.</span><span class="nx">usePositionCache</span><span class="p">){</span>
          <span class="nx">cache</span><span class="p">.</span><span class="nx">used</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="kd">var</span> <span class="nx">startNode</span> <span class="o">=</span> <span class="nx">getStart</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="nx">type</span><span class="p">),</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">do</span><span class="p">{</span>
            <span class="nx">cache</span><span class="p">[</span><span class="nx">getUid</span><span class="p">(</span><span class="nx">startNode</span><span class="p">)]</span> <span class="o">=</span> <span class="o">++</span><span class="nx">index</span>
          <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="nx">startNode</span> <span class="o">=</span> <span class="nx">next</span><span class="p">(</span><span class="nx">startNode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">_uid</span><span class="p">]</span>
        <span class="k">if</span><span class="p">((</span><span class="nx">position</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span><span class="o">/</span><span class="nx">step</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">position</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span><span class="o">%</span><span class="nx">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
          <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">nthPositionCache</span> <span class="o">=</span> <span class="p">{</span><span class="nx">used</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="nx">clearNthPositionCache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">nthPositionCache</span><span class="p">.</span><span class="nx">used</span><span class="p">){</span>
        <span class="nx">nthPositionCache</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">child</span><span class="o">:</span><span class="p">{},</span>
          <span class="nx">lastchild</span><span class="o">:</span><span class="p">{},</span>
          <span class="nx">type</span><span class="o">:</span><span class="p">{},</span>
          <span class="nx">lasttype</span><span class="o">:</span><span class="p">{},</span>
          <span class="nx">length</span><span class="o">:</span><span class="mi">0</span>
        <span class="p">}</span>
      <span class="p">}</span> 
    <span class="p">}</span>
    <span class="nx">clearNthPositionCache</span><span class="p">()</span>

  <span class="kd">var</span> 
    <span class="nx">finders</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">byId</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">node</span><span class="o">?</span> <span class="p">[</span><span class="nx">node</span><span class="p">]</span> <span class="o">:</span> <span class="p">[]</span> 
      <span class="p">},</span>
      <span class="nx">byClassName</span><span class="o">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="o">?</span><span class="kd">function</span><span class="p">(</span><span class="nx">classList</span><span class="p">,</span><span class="nx">node</span><span class="p">){</span>
        <span class="nx">classList</span> <span class="o">==</span> <span class="nx">classList</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">toArray</span><span class="p">((</span><span class="nx">node</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">classList</span><span class="p">))</span>
      <span class="p">}</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
      <span class="nx">byTagName</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">node</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>filters 这里简化到过滤单个节点 逻辑清晰 性能可能有所损失</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">filters</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">id</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span>
      <span class="p">},</span>
      <span class="nx">classList</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">classList</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">classList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
         <span class="nx">className</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">node</span><span class="p">.</span><span class="nx">className</span><span class="o">+</span><span class="s2">&quot; &quot;</span>

        <span class="k">for</span><span class="p">(</span> <span class="p">;</span><span class="nx">len</span><span class="o">--</span><span class="p">;</span> <span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!~</span><span class="nx">className</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">classList</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="p">)){</span>
            <span class="k">return</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">},</span>
      <span class="nx">tag</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">tag</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">tag</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="nx">tag</span>
      <span class="p">},</span>
      <span class="nx">pesudos</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">pesudos</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">pesudos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">pesudoFilters</span> <span class="o">=</span> <span class="nx">expandFilters</span><span class="p">[</span><span class="s2">&quot;pesudos&quot;</span><span class="p">]</span>

        <span class="k">for</span><span class="p">(</span> <span class="p">;</span><span class="nx">len</span><span class="o">--</span><span class="p">;</span> <span class="p">){</span>
          <span class="kd">var</span> <span class="nx">pesudo</span> <span class="o">=</span> <span class="nx">pesudos</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="nx">pesudo</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
            <span class="nx">filter</span> <span class="o">=</span> <span class="nx">pesudoFilters</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;不支持的伪类:&quot;</span><span class="o">+</span><span class="nx">name</span><span class="p">)</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">pesudo</span><span class="p">.</span><span class="nx">param</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">},</span>
      <span class="nx">attributes</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">operatorFilters</span> <span class="o">=</span> <span class="nx">expandFilters</span><span class="p">[</span><span class="s2">&quot;operators&quot;</span><span class="p">]</span>

        <span class="k">for</span><span class="p">(</span> <span class="p">;</span><span class="nx">len</span><span class="o">--</span><span class="p">;</span> <span class="p">){</span>
          <span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span>
            <span class="nx">operator</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">[</span><span class="s2">&quot;operator&quot;</span><span class="p">],</span>
            <span class="nx">filter</span> <span class="o">=</span> <span class="nx">operatorFilters</span><span class="p">[</span><span class="nx">operator</span><span class="p">]</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">operator</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">key</span><span class="p">)){</span>
              <span class="k">return</span> <span class="kc">false</span>
            <span class="p">}</span>
            <span class="k">continue</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;不支持的操作符:&quot;</span><span class="o">+</span><span class="nx">operator</span><span class="p">)</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">value</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h2>expandFilters </h2>

<p>原生可扩展的方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">expandFilters</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">combos</span><span class="o">:</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h2>这里是神级扩展, 带来了良好的接口，但是对性能略有影响</h2>

<p>选择符filter 与其他filter不同 node 同样是当前节点 区别是
如果成功返回成功的上游节点(可能是父节点 可能是兄弟节点等等)
其中 match(node) 返回 这个上游节点是否匹配剩余选择符(内部仍是一个递归)</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="s2">&quot;&gt;&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">match</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nx">parent</span><span class="p">))</span> <span class="k">return</span> <span class="nx">parent</span>
        <span class="p">},</span>
        <span class="s2">&quot;~&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">match</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">while</span><span class="p">(</span><span class="nx">prev</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nx">prev</span><span class="p">))</span> <span class="k">return</span> <span class="nx">prev</span>
            <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot; &quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">match</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
          <span class="k">while</span><span class="p">(</span><span class="nx">parent</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">pass</span> <span class="o">=</span> <span class="nx">match</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">pass</span><span class="p">)</span> <span class="k">return</span> <span class="nx">parent</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">pass</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span>
            <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="s2">&quot;+&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">match</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">prev</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">(</span><span class="nx">prev</span><span class="p">))</span> <span class="k">return</span> <span class="nx">prev</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">operators</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;^=&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span> <span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">nodeValue</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">nodeValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span>
          <span class="k">return</span> <span class="nx">nodeValue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="s2">&quot;=&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span> <span class="o">==</span> <span class="nx">value</span>
        <span class="p">},</span>
        <span class="s2">&quot;~=&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">nodeValue</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">nodeValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span>

          <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">nodeValue</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">),</span>
            <span class="nx">len</span><span class="o">=</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span>

          <span class="k">for</span><span class="p">(;</span><span class="nx">len</span><span class="o">--</span><span class="p">;){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="s2">&quot;$=&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">realValue</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="k">return</span> <span class="k">typeof</span> <span class="nx">realValue</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">realValue</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">realValue</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">},</span>
        <span class="s2">&quot;|=&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">realValue</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span><span class="o">||</span><span class="s2">&quot;&quot;</span>
          <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">realValue</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">value</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;*=&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
          <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span><span class="o">||</span><span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">pesudos</span><span class="o">:</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>TODO:这里如果出自 SELECtorAPI 标注下处处</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="s2">&quot;not&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">){</span>
          <span class="k">return</span> <span class="o">!</span><span class="nx">matches</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;matches&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span>
        <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>child pesudo</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="s2">&quot;nth-child&quot;</span><span class="o">:</span><span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;nth-last-child&quot;</span><span class="o">:</span><span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;nth-of-type&quot;</span><span class="o">:</span><span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;nth-last-of-type&quot;</span><span class="o">:</span><span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;first-child&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">nthChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node</span>
        <span class="p">},</span>
        <span class="s2">&quot;last-child&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">nthLastChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node</span>
        <span class="p">},</span>
        <span class="s2">&quot;last-of-type&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">nthLastChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node</span>
        <span class="p">},</span>
        <span class="s2">&quot;first-of-type&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">nthChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node</span>
        <span class="p">},</span>
        <span class="s2">&quot;root&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">param</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">node</span> <span class="o">===</span> <span class="nx">root</span>
        <span class="p">},</span>
        <span class="s2">&quot;only-child&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="o">!</span><span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;only-of-type&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="o">!</span><span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;checked&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">checked</span> <span class="o">===</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="s2">&quot;enabled&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">===</span> <span class="kc">false</span> 
        <span class="p">},</span>
        <span class="s2">&quot;disabled&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">===</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="s2">&quot;empty&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">===</span> <span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;focus&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">===</span> <span class="nx">node</span>
        <span class="p">},</span>
        <span class="s2">&quot;selected&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">selected</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>这里主要是整合之前的ExpandsFilter中的mathch, 单层数据</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">matchDatum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">datum</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">subFilter</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">datum</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">ignored</span> <span class="o">!==</span><span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">subFilter</span> <span class="o">=</span> <span class="nx">filters</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">subFilter</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">datum</span><span class="p">[</span><span class="nx">i</span><span class="p">])){</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>将一组数据用datum过滤</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">filterDatum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">datum</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">len</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span>
      <span class="k">for</span><span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">matchDatum</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span> <span class="nx">datum</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">))</span> <span class="nx">results</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">len</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">results</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>动态产生供FilterOneNode使用的match</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">createMatch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">datum</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">node</span> <span class="o">==</span> <span class="nx">context</span><span class="o">||</span> <span class="nx">node</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span> <span class="c1">//null 相当于休止符</span>
        <span class="k">return</span> <span class="nx">matchDatum</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">datum</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">createMatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span> <span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">createMatch</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">context</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">matches</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>判断每一个node是否匹配相应的选择符, 
到这里为止终于把context抛弃，信息封在了matches中</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">filterOneNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">matches</span><span class="p">,</span><span class="nx">data</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span><span class="p">(;</span><span class="nx">len</span><span class="o">--</span><span class="p">;){</span>
          <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span> 
          <span class="nx">getNext</span> <span class="o">=</span> <span class="nx">expandFilters</span><span class="p">.</span><span class="nx">combos</span><span class="p">[</span><span class="nx">datum</span><span class="p">.</span><span class="nx">combo</span><span class="p">],</span>
          <span class="nx">next</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">getNext</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;不支持的连接符:&quot;</span><span class="o">+</span><span class="nx">datum</span><span class="p">.</span><span class="nx">combo</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">getNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">matches</span><span class="p">[</span><span class="nx">len</span><span class="p">])){</span>
          <span class="nx">node</span> <span class="o">=</span> <span class="nx">next</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h2>过滤主函数filter</h2>

<p>自底向上过滤非匹配节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="nx">data</span><span class="p">,</span><span class="nx">context</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span>  
</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>这里是为了缓存match匹配函数</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">createMatches</span><span class="p">(</span><span class="nx">data</span> <span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="c1">//</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">filterOneNode</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">matches</span><span class="p">,</span><span class="nx">data</span><span class="p">)){</span>
          <span class="nx">results</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">results</span>
    <span class="p">},</span>
    <span class="nx">getTargets</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">results</span><span class="p">,</span><span class="nx">ignored</span> 
      <span class="k">if</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span> 
        <span class="nx">results</span> <span class="o">=</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byId</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> 
        <span class="nx">ignored</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">classList</span> <span class="o">&amp;&amp;</span> <span class="nx">lastPiece</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byClassName</span><span class="p">){</span>
        <span class="nx">results</span> <span class="o">=</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byClassName</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">classList</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
        <span class="nx">ignored</span> <span class="o">=</span> <span class="s2">&quot;classList&quot;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">results</span> <span class="o">=</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byTagName</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">tag</span><span class="o">||</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
        <span class="nx">ignored</span> <span class="o">=</span> <span class="s2">&quot;tag&quot;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span>
      <span class="k">return</span> <span class="nx">filterDatum</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">lastPiece</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h2>API 3 : find (private)</h2>

<p>根据parse后的数据进行节点查找
options:
   1. parsed.data  parse数据为一数组
   2. node         context节点
事实上没有data这个单词，我这里算是自定了这个单词
    datas : [data,data] <br />
    data : [datum, datum]
    datum: {tag:"*"....etc}</p>             </td>             <td class="code">               <div class="highlight"><pre>
 
  <span class="kd">var</span> <span class="nx">find</span> <span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">datas</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">datas</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">dlen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">last</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">filter</span><span class="p">(</span><span class="nx">getTargets</span><span class="p">(</span><span class="nx">last</span><span class="p">,</span> <span class="nx">context</span><span class="p">),</span> <span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nx">context</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">len</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="nx">distinct</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortor</span><span class="p">)</span> 
    <span class="nx">clearNthPositionCache</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">results</span>
  <span class="p">}</span> 
</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h2>API 4: 测试用get相当于all (private)</h2>

<p>为了测试时避免原生querySelector的影响</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">sl</span><span class="p">).</span><span class="nx">data</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span>  <span class="nx">find</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span><span class="o">||</span><span class="nx">doc</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <h2>API </h2>             </td>             <td class="code">               <div class="highlight"><pre>
  
  <span class="kd">var</span> <span class="nx">one</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">node</span>
    <span class="k">try</span><span class="p">{</span>
      <span class="nx">node</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span><span class="o">||</span><span class="nx">doc</span><span class="p">).</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">sl</span><span class="p">)</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>这里不能在匹配第一个之后停止，因为还需要document sorter</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">node</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span><span class="nx">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">node</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">nodeList</span>
    <span class="k">try</span><span class="p">{</span>
      <span class="nx">nodeList</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span><span class="o">||</span><span class="nx">doc</span><span class="p">).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">sl</span><span class="p">)</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="nx">nodeList</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span><span class="nx">context</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nodeList</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>matches 单步调用方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">matchOneData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">data</span><span class="p">,</span><span class="nx">context</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">matchDatum</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">context</span><span class="p">)){</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">return</span> <span class="nx">filter</span><span class="p">([</span><span class="nx">node</span><span class="p">],</span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nx">context</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span><span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <h2>API 5: selector api 2 matches (public)</h2>

<p>nes的matches支持用分隔符链接符组合的复杂选择器
即与all、one函数的支持是一样的
由于:not与:matches依赖于这个函数 ,所以同样支持复杂选择器</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">datas</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">sl</span><span class="p">).</span><span class="nx">data</span><span class="p">,</span>
      <span class="nx">len</span> <span class="o">=</span> <span class="nx">datas</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="nx">doc</span>
    <span class="k">for</span><span class="p">(</span> <span class="p">;</span><span class="nx">len</span><span class="o">--</span><span class="p">;</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">matchOneData</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">datas</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span><span class="nx">context</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="p">}</span> 


  
</pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <h2>ASSEMBLE</h2>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="nx">setup</span><span class="p">()</span>                     <span class="c1">// 动态组装parser</span>

</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h2>生成pesudo 、 operator、combo 等expand方法</h2>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">;(</span><span class="kd">function</span> <span class="nx">createExpand</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span><span class="nx">beforeAssign</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">host</span><span class="p">){</span>
      <span class="nx">nes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">host</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">autoSet</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">container</span><span class="p">[</span><span class="nx">key</span><span class="p">]){</span>
            <span class="nx">container</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">beforeAssign</span><span class="p">){</span>
              <span class="nx">beforeAssign</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">})(</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="nx">expandFilters</span><span class="p">,{</span>
    <span class="s2">&quot;operators&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">befores</span><span class="o">=</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
      <span class="nx">befores</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">key</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
      <span class="nx">macros</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="nx">befores</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="nx">setup</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="s2">&quot;combos&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">befores</span><span class="o">=</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">combo</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
      <span class="nx">befores</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">key</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
      <span class="nx">macros</span><span class="p">.</span><span class="nx">combo</span> <span class="o">=</span> <span class="nx">befores</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="nx">setup</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="nx">extend</span><span class="p">(</span><span class="nx">nes</span><span class="p">,{</span>
</pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>setting stuff 设置它们的length控制缓存</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">nthCache</span><span class="o">:</span> <span class="nx">nthCache</span><span class="p">,</span>
    <span class="nx">parseCache</span> <span class="o">:</span><span class="nx">parseCache</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>是否用节点缓存节点位置,默认true</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">usePositionCache</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>测试接口</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">_parse</span><span class="o">:</span> <span class="nx">parse</span><span class="p">,</span> <span class="c1">//解析</span>
    <span class="nx">_find</span><span class="o">:</span> <span class="nx">find</span><span class="p">,</span>   <span class="c1">//查找</span>
    <span class="nx">_get</span><span class="o">:</span> <span class="nx">get</span><span class="p">,</span>     <span class="c1">//测试时排除原生querySelector的影响</span>

</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h2>       <em>主要API</em></h2>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">one</span><span class="o">:</span><span class="nx">one</span><span class="p">,</span>
    <span class="nx">all</span><span class="o">:</span><span class="nx">all</span><span class="p">,</span>
    <span class="nx">matches</span><span class="o">:</span><span class="nx">matches</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>内建扩展 api</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>pesudos:pesudos, 这三个已经内建
operators:operators
combos:combos</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>规则扩展API</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">addRule</span><span class="o">:</span><span class="nx">addRule</span>

</pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">})</span>

</pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h2>         5.Exports</h2>

<p>暴露API:  amd || commonjs || NEJ define || global 
支持commonjs</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">nes</span>
</pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>支持amd</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">nes</span>
    <span class="p">})</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">NEJ</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">define</span> <span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="p">){</span>
</pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>支持NEJ</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">win</span><span class="p">.</span><span class="nx">nes</span> <span class="o">=</span> <span class="nx">nes</span> 
      <span class="nx">nes</span><span class="p">.</span><span class="nx">noConflict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">namespace</span><span class="p">){</span>
        <span class="nx">NEJ</span><span class="p">.</span><span class="nx">P</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nx">_$nes</span> <span class="o">=</span> <span class="nx">nes</span>
        <span class="nx">win</span><span class="p">.</span><span class="nx">nes</span> <span class="o">=</span> <span class="nx">prevNes</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>直接暴露到全局</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">win</span><span class="p">.</span><span class="nx">nes</span> <span class="o">=</span> <span class="nx">nes</span>
    <span class="nx">nes</span><span class="p">.</span><span class="nx">noConflict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
      <span class="nx">win</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nes</span>
      <span class="nx">win</span><span class="p">.</span><span class="nx">nes</span> <span class="o">=</span> <span class="nx">prevNes</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}(</span><span class="nb">window</span><span class="p">,</span><span class="nb">document</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>TODO: 内容
1. 重构 √
2. 自定义ruler 并setup  √
3. nthChild方法的重构 直接从childNodes中进行判断而不是同级游走 X 测试结果排除
4. 准备{a,b}(类似regexp的例子) √
5. 准备好pesudo(incude?) attr combo的例子 √
6. try cache 捕获未被系统识别的selector √
7. 准备好delegate Event的例子 √
9. Wrapper扩展接口  X 不需要扩展类，只做选择器
10.nwmatcher提到几个兼容性处理 
11.调用combo、operator时候动态将规则写进macro中并setup √
12.将combo的优先级降到最低 (因为单字符更容易被匹配到) X 暂时不做
13.完成nth的优化</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 