<!DOCTYPE html>  <html> <head>   <title>nes.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="extend_combo.html">                 extend_combo.js               </a>                                           <a class="source" href="extend_operator.html">                 extend_operator.js               </a>                                           <a class="source" href="extend_parser.html">                 extend_parser.js               </a>                                           <a class="source" href="extend_pesudo.html">                 extend_pesudo.js               </a>                                           <a class="source" href="extend_rule.html">                 extend_rule.js               </a>                                           <a class="source" href="nes.html">                 nes.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               nes.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="o">!</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">win</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><strong>nes命名空间</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">nes</span> <span class="o">=</span> <span class="p">{</span><span class="nx">version</span><span class="o">:</span> <span class="s2">&quot;0.0.5&quot;</span><span class="p">},</span>
    <span class="nx">locals</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">//存放local属性...被global坑死了</span>


</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>常用属性local化</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">ap</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">op</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">sp</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">fp</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nx">slice</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span>
    <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
    <span class="nx">testNode</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">),</span>
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>1. Helper(助手函数)</h1>

<p>将类数组(如Nodelist、Argument)变为数组</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>够用的短小类型判断 </p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">typeOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nb">String</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">:</span> <span class="nx">op</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>够用的简单对象扩展</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o1</span><span class="p">,</span> <span class="nx">o2</span><span class="p">,</span> <span class="nx">override</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">o2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">o1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">override</span><span class="p">)</span> <span class="nx">o1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>最简单先进先出缓存队列, max设置最大缓存长度, 为了不必要重复parse
nes会多次用到这个方法创建cache</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">createCache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">cache</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]</span>
          <span class="p">}</span>
          <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
          <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">value</span>
        <span class="p">},</span>
        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cache</span>
          <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="nx">length</span><span class="o">:</span> <span class="nx">max</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>让setter型函数fn支持object型的参数 
即支持<code>set(name:value)</code> 
也支持<code>set({name1:value1,name2:value2})</code></p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">autoSet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">key</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">assert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">()</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nx">testNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Fixed: toArray 低于IE8的 Nodelist无法使用slice获得array</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span>
    <span class="p">}</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>扩展ES5 Native支持的函数，坑爹的远古浏览器
es5 trim</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">trimReg</span> <span class="o">=</span> <span class="sr">/^\s+|\s+$/g</span>
  <span class="nx">sp</span><span class="p">.</span><span class="nx">trim</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">trim</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">trimReg</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>es5 bind</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">fp</span><span class="p">.</span><span class="nx">bind</span> <span class="o">=</span> <span class="nx">fp</span><span class="p">.</span><span class="nx">bind</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>es5 Array indexOf</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">ap</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">||</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">return</span> <span class="nx">i</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Parser 相关</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span>
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>抽离出字匹配数目</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">ignoredRef</span> <span class="o">=</span> <span class="sr">/\(\?\!|\(\?\:/</span><span class="p">,</span>
    <span class="nx">extractRefNum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">regStr</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">ignored</span> <span class="o">=</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">ignoredRef</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">//忽略非捕获匹配</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">letter</span> <span class="o">=</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">len</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;\\&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//不包括转义括号</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">letter</span> <span class="o">===</span> <span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="nx">left</span><span class="o">++</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">letter</span> <span class="o">===</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="nx">right</span><span class="o">++</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">!==</span> <span class="nx">right</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">regStr</span> <span class="o">+</span> <span class="s2">&quot;中的括号不匹配&quot;</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nx">left</span> <span class="o">-</span> <span class="nx">ignored</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>前向引用 如\1 \12 等在TRUNK合并时要做处理</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">refIndexReg</span> <span class="o">=</span> <span class="sr">/\\(\d+)/g</span><span class="p">,</span>
    <span class="nx">extractRefIndex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">regStr</span><span class="p">,</span> <span class="nx">curIndex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">regStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">refIndexReg</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;\\&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">+</span> <span class="nx">curIndex</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>// 生成默认的action，这个会将匹配到的参数推入一个同名的数组内
createAction = function(name) {
  return function(all) {
    var parsed = this.parsed,
      current = parsed[name] || (parsed[name] = [])
      current.push(slice.call(arguments))
  }
},
Object.keys 规则排序时的调用方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">prop</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>将规则中的reg中的macro替换掉</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">cleanRule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">reg</span>
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>如果已经是regexp了就转为string</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">reg</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;regexp&quot;</span><span class="p">)</span> <span class="nx">reg</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>将macro替换</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">replaceReg</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="k">in</span> <span class="nx">macros</span><span class="p">)</span> <span class="k">return</span> <span class="nx">macros</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;can&quot;t replace undefined macros:&#39;</span> <span class="o">+</span> <span class="nx">b</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="k">return</span> <span class="nx">rule</span>
    <span class="p">},</span> 
    <span class="nx">cleanRules</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="nx">cleanRule</span><span class="p">(</span><span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">rules</span>
    <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>2. Parser</h2>

<p>为何要抽象成一个类? 其实这里只用到了一个实例
事实上这个简单Parser还帮我实现了命令行参数解析，
zen-coding的实现等等, 它可以帮助实现基于正则式的
字符串解析</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">Parser</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">macros</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_macros</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">macros</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_links</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">//symbol link map</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rules</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">//symbol def</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">TRUNK</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="nx">createCache</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">maxCache</span> <span class="o">||</span> <span class="mi">200</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[[]])</span> <span class="c1">//输入空字符串返回空数组</span>
    <span class="p">}</span>

  <span class="nx">extend</span><span class="p">(</span><span class="nx">Parser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>解析输入字符串input、返回action定义的data数据</h3>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>清理input数据、因为parsed数据最终会被缓存，
我们要尽量让相同的选择器只对应一份parsed数据</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">input</span> <span class="o">=</span> <span class="nx">clean</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>先检查缓存中是否有数据</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="k">return</span> <span class="nx">parsed</span>
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>如果没有: 初始化参数</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsed</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">null</span><span class="p">]</span>
      <span class="p">],</span>
        <span class="nx">remain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">input</span><span class="p">,</span>
        <span class="nx">TRUNK</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">TRUNK</span>
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>将remain进行this._process这里每匹配一个字符串都会进行一次reduce</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">while</span> <span class="p">(</span><span class="nx">remain</span> <span class="o">!=</span> <span class="p">(</span><span class="nx">remain</span> <span class="o">=</span> <span class="nx">remain</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">TRUNK</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_process</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))))</span> <span class="p">{}</span>
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>如果没有被解析完 证明选择器字符串有不能被解析的部分</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">remain</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">remain</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>返回数据并推入cache</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">parsed</span><span class="p">)</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h3>添加新规则 :</h3>

<p>在nes中你可以想象成添加一个与Id、className、pesudo等价简单选择符</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">on</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//当不是hash传入时</span>
        <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nx">tmp</span><span class="p">[</span><span class="nx">rules</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nx">rules</span> <span class="o">=</span> <span class="nx">tmp</span>
      <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>可以同时接受object型或者key, value对的参数</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">rule</span> <span class="o">=</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rule</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">regexp</span><span class="o">:</span> <span class="nx">rule</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">reg</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;regexp&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>初始化order</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">order</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rule</span>
      <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>每进行一次新规则监听，都重新组装一次</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">this</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3><strong>删除规则</strong> :</h3>

<p>删除对应规则, 即nes的规则都是在运行时可删可增的</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">off</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;array&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">name</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>获得当前解析位置所在的datum，你只需要在这个datum中塞数据即可</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">current</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsed</span>
      <span class="kd">var</span> <span class="nx">piece</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">piece</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">return</span> <span class="nx">piece</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">piece</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag</span><span class="o">:</span> <span class="s2">&quot;*&quot;</span>
      <span class="p">})</span>
    <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;输入  &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">+</span> <span class="s2">&quot;  含有未识别语句:&quot;</span> <span class="o">+</span> <span class="nx">info</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">},</span>

    <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parser</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Parser</span><span class="p">().</span><span class="nx">on</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">)</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><strong><code>this.parser</code></strong>的依赖方法，
即遍历links检查是否有子匹配满足关系，
有则推入对应的action数组,
注意由于其是是replace方法的调用，每次都要返回""完成
reduce操作</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">_process</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_links</span><span class="p">,</span>
        <span class="nx">rules</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">,</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">links</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
            <span class="nx">retain</span> <span class="o">=</span> <span class="nx">link</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="nx">index</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">rule</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">retain</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>组装</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">cleanRules</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">)</span>
      <span class="kd">var</span> <span class="nx">curIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>当前下标</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">splits</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">rules</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rules</span><span class="p">,</span>
        <span class="nx">links</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_links</span><span class="p">,</span>
        <span class="nx">ruleNames</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">(</span><span class="nx">rules</span><span class="p">).</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">a</span><span class="p">].</span><span class="nx">order</span> <span class="o">&gt;=</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">b</span><span class="p">].</span><span class="nx">order</span>
        <span class="p">}),</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">ruleNames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">ruleNames</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span>
          <span class="nx">rule</span> <span class="o">=</span> <span class="nx">rules</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
          <span class="nx">retain</span> <span class="o">=</span> <span class="nx">extractRefNum</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">// 1就是那个all</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">filter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">filters</span><span class="p">[</span><span class="nx">i</span><span class="p">]){</span> 
          <span class="nx">filters</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">filter</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
          <span class="p">}</span> <span class="c1">//将filter转移到filters下</span>

        <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">curIndex</span><span class="p">,</span> <span class="nx">retain</span><span class="p">]</span> <span class="c1">//分别是rule名，参数数量</span>
        <span class="kd">var</span> <span class="nx">regexp</span> <span class="o">=</span> <span class="nx">extractRefIndex</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">regexp</span><span class="p">,</span> <span class="nx">curIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">curIndex</span> <span class="o">+=</span> <span class="nx">retain</span><span class="p">;</span>
        <span class="nx">splits</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">regexp</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">TRUNK</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^(?:(&quot;</span> <span class="o">+</span> <span class="nx">splits</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;)|(&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span>
  <span class="p">})</span>



</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h3>parse的规则定义部分开始</h3>

<p>一些用到的正则式，但是又不属于parser的规则组成</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span>
    <span class="nx">replaceReg</span> <span class="o">=</span> <span class="sr">/\{\{([^\}]*)\}\}/g</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>替换rule中的macro</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">nthValueReg</span> <span class="o">=</span> <span class="sr">/^(?:(\d+)|([+-]?\d*)?n([+-]\d+)?)$/</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>nth伪类的value规则</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">posPesudoReg</span> <span class="o">=</span> <span class="sr">/^(nth)[\w-]*(-of-type|-child)/</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>判断需要pos
第一个cache 用来装载nth伪类中的参数解析后的数据
如nth-child、nth-of-type等8个伪类</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">nthCache</span> <span class="o">=</span> <span class="nx">createCache</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>提取nthValue中的有用信息 比如an + b 我们需要提取出a以及,b并对额外情况如缺少a参数或b参数
或者有a、b小于0这些情况作统一处理，返回find适合使用的数据</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">extractNthValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">res</span>
</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>如果无参数 当成是获取第一个元素</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">param</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">param</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">step</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">nthCache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">param</span><span class="p">))</span> <span class="k">return</span> <span class="nx">res</span>
</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>对even odd等转化为标准的a，b组合(即step与start)</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">param</span> <span class="o">==</span> <span class="s2">&quot;even&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">param</span> <span class="o">==</span> <span class="s2">&quot;odd&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">nthValueReg</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>对错误的nth参数抛出错误</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="nx">step</span> <span class="o">=</span> <span class="kc">null</span> <span class="c1">// 无论其他参数，如果step为null，则永远为false</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nx">start</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mi">1</span>
            <span class="nx">start</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">step</span> <span class="o">=</span> <span class="kc">null</span> <span class="c1">//标志false</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">start</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nx">start</span><span class="p">)</span> <span class="o">%</span> <span class="nx">step</span> <span class="o">+</span> <span class="nx">step</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nthCache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span>
        <span class="nx">step</span><span class="o">:</span> <span class="nx">step</span>
      <span class="p">})</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h3>parse Rule 相关</h3>

<p>了解bison等解析器生成的同学可以把这部分看成是词法与语法定义的杂糅
很混乱也很不标准，但对于选择器这种最简单的DSL其实够用，并且有了奇效
整个Parser根据rules动态产生(即可在使用时发生改变)
具体的流程是下面的rules对象定义了一组语法(词法?)rule——如attribute，
你可以把每个rule中的reg想象成一个token(word?),这些token可能会有{{word}}这种占位符
占位符首先会被macros中对应的macro替换，然后这些token会被组装成一个大版的Regexp，即上面的
Trunk变量,这个过程没什么特殊，一般比较优秀的选择器都是基于这个方法。 在nes中,最终的Trunk可能是
这样的:</p>

<p><code>/(\s*,\s*)|(#([\w\u4e00-\u9fbf-]+))|(\*|\w+)|(\.([\w\u4e00-\u9fbf-]+))|
(:([\w\u4e00-\u9fbf-]+)(?:\(([^\(\)]*|(?:\([^\)]+\)|[^\(\)]*)+)\))?)|
(\[([\w\u4e00-\u9fbf-]+)(?:([*^$|~!]?=)['"]?((?:[\w\u4e00-\u9fbf-]||\s)+)['"]?)?\])|(::([\w\u4e00-\u9fbf-]+))
|([&gt;\s+~&amp;%](?!=))|(\s*\{\s*(\d*),(\-?\d*)\s*\}\s*)/g</code></p>

<p>看到上面那长串，你大概理解了将regexp按词法分开这样做的第一个原因 : <strong>维护</strong>. 
第二个原因就是: <strong>效率</strong>  一次大型正则的调用时间要远低于多次小型正则的匹配(前提它们做同样规模的匹配)</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span>
</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>一些macro</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">macros</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">split</span><span class="o">:</span> <span class="s2">&quot;\\s*,\\s*&quot;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>分隔符</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">operator</span><span class="o">:</span> <span class="s2">&quot;[*^$|~!]?=&quot;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>属性操作符 如= 、!=</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">combo</span><span class="o">:</span> <span class="s2">&quot;[&gt;\\s+~](?!=)&quot;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>连接符 如 > ~ 
中文unicode范围http://baike.baidu.com/view/40801.htm#sub40801_3</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">word</span><span class="o">:</span> <span class="s2">&quot;[\\\\\\w\\u4e00-\\u9fbf-]&quot;</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>语法规则定义</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">rules</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">split</span><span class="o">:</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>分隔符 如 ，</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;{{split}}&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="kc">null</span><span class="p">])</span>
        <span class="p">},</span>
        <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>id 如 #home</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">id</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;#({{word}}+)&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span>
        <span class="p">}</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>节点类型选择符 如 div</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">tag</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;\\*|[a-zA-Z-]\\w*&quot;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>单纯的添加到</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">tag</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>类选择符 如 .m-home</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">classList</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;\\.({{word}}+)&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
            <span class="nx">classList</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">classList</span> <span class="o">||</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">classList</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="nx">classList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>伪类选择符 如 :nth-child(3n+4)</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">pesudos</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;:({{word}}+)&quot;</span> <span class="o">+</span> <span class="c1">//伪类名</span>
        <span class="s2">&quot;(?:\\(&quot;</span> <span class="o">+</span> <span class="c1">//括号开始</span>
        <span class="s2">&quot;([^\\(\\)]*&quot;</span> <span class="o">+</span> <span class="c1">//第一种无括号</span>
        <span class="s2">&quot;|(?:&quot;</span> <span class="o">+</span> <span class="c1">//有括号(即伪类中仍有伪类并且是带括号的)</span>
        <span class="s2">&quot;\\([^\\)]+\\)&quot;</span> <span class="o">+</span> <span class="c1">//括号部分</span>
        <span class="s2">&quot;|[^\\(\\)]*&quot;</span> <span class="o">+</span> <span class="s2">&quot;)+)&quot;</span> <span class="o">+</span> <span class="c1">//关闭有括号</span>
        <span class="s2">&quot;\\))?&quot;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>关闭最外圈括号</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
            <span class="nx">pesudos</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">pesudos</span> <span class="o">||</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">pesudos</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="nx">param</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">posPesudoReg</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>parse 的成本是很小的 尽量在find前把信息准备好
这里我们会把nth-child(an+b) 的 a 与 b 在不同输入下标准化</p>             </td>             <td class="code">               <div class="highlight"><pre>
              <span class="nx">param</span> <span class="o">=</span> <span class="nx">extractNthValue</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="nx">pesudos</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
            <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
            <span class="nx">param</span><span class="o">:</span> <span class="nx">param</span>
          <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>属性选择符  如  [class=hahaha]</p>

<p>这里以属性选择符为例，说明下reg与action的关系</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;\\[\\s*({{word}}+)(?:({{operator}})[\&#39;\&quot;]?([^\&#39;\&quot;\\[]+)[\&#39;\&quot;]?)?\\s*\\]&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="nx">attributes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
              <span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span>
              <span class="nx">operator</span><span class="o">:</span> <span class="nx">operator</span><span class="p">,</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span>
            <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>伪元素可以实现么？ 占位</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">combo</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">reg</span><span class="o">:</span> <span class="s2">&quot;\\s*({{combo}})\\s*&quot;</span><span class="p">,</span>
        <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">combo</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsed</span><span class="p">,</span>
            <span class="nx">cur</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">combo</span> <span class="o">=</span> <span class="nx">combo</span>
            <span class="nx">cur</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">cleanReg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;\\s*(,|&quot;</span> <span class="o">+</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">combo</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">operator</span> <span class="o">+</span> <span class="s2">&quot;)\\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">)</span>
  <span class="nx">clean</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sl</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cleanReg</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h3>parser生成</h3>

<p>初始化parser实例</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Parser</span><span class="p">()</span>
  <span class="nx">parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span> <span class="c1">//生成规则</span>
</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>为了兼容前面版本，仍然提供这个parse函数, 也为了与find想对应</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">sl</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">sl</span><span class="p">)</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <h1>  3. Finder</h1>

<h2>  Util</h2>

<p>将nodelist转变为array</p>

<h2> DOM related Util</h2>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">attrMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;for&#39;</span><span class="o">:</span> <span class="s2">&quot;htmlFor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;href&quot;</span> <span class="k">in</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
      <span class="k">return</span> <span class="s2">&quot;type&quot;</span> <span class="k">in</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">:</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">checkTagName</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">testNode</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">createComment</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">));</span>
</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>有些版本的getElementsByTagName("*")会返回注释节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">return</span> <span class="o">!</span><span class="nx">testNode</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">||</span> 
</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>低版本ie下input name 或者 id为length时 length返回异常</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">typeof</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!==</span> <span class="s2">&quot;number&quot;</span>
  <span class="p">});</span>
</pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>form <strong>sizzle</strong>line200 判断getAttribute是否可信</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">checkAttributes</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">testNode</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;select&gt;&lt;/select&gt;&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">testNode</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;multiple&quot;</span><span class="p">))</span>
</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>IE8 returns a string for some attributes even when not present</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">type</span> <span class="o">!==</span> <span class="s2">&quot;boolean&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>将nth类方法的判断部分统一抽离出来,
其中type代表是否是nth-type-of类型的判断,下面类似</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">checkNth</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="nx">type</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>获得父节点node的顺数第n(从1开始)个子节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">nthChild</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">checkNth</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span> <span class="nx">n</span><span class="o">--</span>
      <span class="k">return</span> <span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>获得父节点node的倒数第n(从1开始)个子节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">nthLastChild</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">lastChild</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">checkNth</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span> <span class="nx">n</span><span class="o">--</span>
      <span class="k">return</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>获得节点node的第n(从1开始)个前置兄弟节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">checkNth</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span> <span class="nx">n</span><span class="o">--</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">node</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>获得节点node的倒数第n(从1开始)个前置兄弟节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">checkNth</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span> <span class="nx">n</span><span class="o">--</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">node</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>获得节点node的key属性的值, 修改自from sizzle...蛋疼啊各浏览器的属性获取</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">attrMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="k">return</span> <span class="k">typeof</span> <span class="nx">map</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">map</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">:</span> <span class="nx">node</span><span class="p">[</span><span class="nx">map</span><span class="p">]</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">checkAttributes</span><span class="p">){</span><span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">key</span><span class="p">);}</span>
      <span class="kd">var</span> <span class="nx">attrNode</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
</pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>对于selected checked 当返回为bool值时  将其标准化为 selected = "selected"
方便后续处理</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">return</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;boolean&quot;</span> <span class="o">?</span> 
</pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>很多时候null可以作为标志位，nes中大部分特殊flag都用null标示</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?</span> <span class="nx">key</span> <span class="o">:</span> <span class="kc">null</span> <span class="o">:</span>   
          <span class="nx">attrNode</span> <span class="o">&amp;&amp;</span> <span class="nx">attrNode</span><span class="p">.</span><span class="nx">specified</span> <span class="o">&amp;&amp;</span> <span class="nx">attrNode</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="kc">null</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p><strong>数组去重</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">distinct</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>先排除 即 如果它是清白的 后面就没有等值元素</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">array</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//不清白</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span> <span class="c1">//不清白</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">array</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>从sizzle抄袭的 document sorter 
将匹配元素集按文档顺序排列好 这很重要!</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">sortor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">)</span> <span class="o">?</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">:</span> <span class="p">(</span><span class="s1">&#39;sourceIndex&#39;</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">)</span> <span class="o">?</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">sourceIndex</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">sourceIndex</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sourceIndex</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">ap</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">],</span>
        <span class="nx">bp</span> <span class="o">=</span> <span class="p">[</span><span class="nx">b</span><span class="p">],</span>
        <span class="nx">aup</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
        <span class="nx">bup</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
        <span class="nx">cur</span> <span class="o">=</span> <span class="nx">aup</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">bup</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bup</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aup</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">aup</span> <span class="o">===</span> <span class="nx">bup</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">siblingCheck</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ap</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
        <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">cur</span> <span class="o">=</span> <span class="nx">bup</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bp</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
        <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">ap</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">bp</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">siblingCheck</span><span class="p">(</span><span class="nx">ap</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">bp</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">siblingCheck</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">a</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>

</pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <h3>nth position Cache 部分</h3>

<p>对于nth类型的查找，有时候一次节点查找会遍历到多次相同节点，
由于一次节点查找时，由于js的单线程，节点不可能发生改变，介于此，我们将
nth类的node的节点位置缓存起来，在本次查找结束后再清空</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>获得node的唯一标示</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">getUid</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_uid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_uid</span> <span class="o">||</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">_uid</span> <span class="o">=</span> <span class="nx">token</span> <span class="o">+</span> <span class="nx">_uid</span><span class="o">++</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})(</span><span class="s2">&quot;nes_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">));</span>
</pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>创建nth相关的Filter，由于都类似，就统一通过工厂函数生成了
参数有两个 <br />
   1. isNext: 代表遍历顺序是向前还是向后
   2. isType: 代表是否是要指定nodeName</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">createNthFilter</span><span class="p">(</span><span class="nx">isNext</span><span class="p">,</span> <span class="nx">isType</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">getStart</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isNext</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cacheKey</span> <span class="o">=</span><span class="nx">isType</span> <span class="o">?</span> <span class="s2">&quot;type&quot;</span> <span class="o">:</span> <span class="s2">&quot;child&quot;</span>
      <span class="nx">next</span> <span class="o">=</span> <span class="nx">nthNext</span>
      <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span>
      <span class="nx">getStart</span> <span class="o">=</span> <span class="nx">nthChild</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Fixed:!!! 这里cache是首次生成的cache被写死了，即使后面clear了也没有用,
即永远无法被释放</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">cacheKey</span> <span class="o">=</span><span class="s2">&quot;last&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">isType</span> <span class="o">?</span> <span class="s2">&quot;type&quot;</span> <span class="o">:</span> <span class="s2">&quot;child&quot;</span><span class="p">)</span>
      <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthNext</span>
      <span class="nx">next</span> <span class="o">=</span> <span class="nx">nthPrev</span>
      <span class="nx">getStart</span> <span class="o">=</span> <span class="nx">nthLastChild</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>实际返回函数, param即pesudo的action定义的参数形如
<code>{step:1, start:1}</code> 所有的类似even、odd或者其他形如n、-3n-11都会标准化
成这种形势</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">nthPositionCache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">===</span> <span class="nx">root</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span> <span class="c1">// 如果是html直接返回false 坑爹啊</span>
      <span class="kd">var</span> <span class="nx">_uid</span> <span class="o">=</span> <span class="nx">getUid</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span>
        <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
        <span class="nx">traverse</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">next</span> <span class="o">:</span> <span class="nx">prev</span><span class="p">,</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">step</span><span class="p">,</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">isType</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span>
</pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Fixed</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span> <span class="c1">//means always false</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">[</span><span class="nx">_uid</span><span class="p">])</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">startNode</span> <span class="o">=</span> <span class="nx">getStart</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">type</span><span class="p">),</span>
          <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">do</span> <span class="p">{</span>
            <span class="nx">cache</span><span class="p">[</span><span class="nx">getUid</span><span class="p">(</span><span class="nx">startNode</span><span class="p">)]</span> <span class="o">=</span> <span class="o">++</span><span class="nx">index</span>
            <span class="nx">nthPositionCache</span><span class="p">.</span><span class="nx">length</span><span class="o">++</span>
            
          <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">startNode</span> <span class="o">=</span> <span class="nx">next</span><span class="p">(</span><span class="nx">startNode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">_uid</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">position</span> <span class="o">===</span> <span class="nx">start</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">position</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">position</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">%</span> <span class="nx">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">nthPositionCache</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">length</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">clearNthPositionCache</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">nthPositionCache</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
      <span class="nx">nthPositionCache</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">child</span><span class="o">:</span><span class="p">{},</span>
        <span class="nx">lastchild</span><span class="o">:</span><span class="p">{},</span>
        <span class="nx">type</span><span class="o">:</span><span class="p">{},</span>
        <span class="nx">lasttype</span><span class="o">:</span><span class="p">{},</span>
        <span class="nx">length</span><span class="o">:</span><span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">}</span> 
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>初始化positioncache</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">clearNthPositionCache</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>这里的几个finders是第一轮获取目标节点集的依赖方法
我没有对byClassName做细致优化，比如用XPath的方式
form sizzle line 147</p>             </td>             <td class="code">               <div class="highlight"><pre>
 
  <span class="kd">var</span> <span class="nx">finders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">byId</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">node</span> <span class="o">?</span> <span class="p">[</span><span class="nx">node</span><span class="p">]</span> <span class="o">:</span> <span class="p">[]</span>
    <span class="p">},</span>
    <span class="nx">byClassName</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="o">?</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">classList</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">classList</span> <span class="o">=</span> <span class="nx">classList</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">toArray</span><span class="p">((</span><span class="nx">node</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">classList</span><span class="p">))</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">byTagName</span><span class="o">:</span> <span class="nx">checkTagName</span> <span class="o">?</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span>
      <span class="kd">var</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;(</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">tmp</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h3>filter:</h3>

<p>Action中塞入的数据会统一先这里处理，可能是直接处理如id、class等简单的.
也可能是分发处理，甚至是多重的分发，如那些复杂的attribute或者是pesudo
这里简化到过滤单个节点 逻辑清晰 ,但可能性能会降低，因为有些属性会重复获取</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">filters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span>
    <span class="p">},</span>
    <span class="nx">classList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">classList</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">classList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">className</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">className</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">classList</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="nx">tag</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="nx">tag</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>pesudos会分发到ExpandsFilter中pesudo中去处理</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">pesudos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">pesudos</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">pesudos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">pesudoFilters</span> <span class="o">=</span> <span class="nx">expandFilters</span><span class="p">[</span><span class="s2">&quot;pesudos&quot;</span><span class="p">]</span>

      <span class="k">for</span> <span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pesudo</span> <span class="o">=</span> <span class="nx">pesudos</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span>
          <span class="nx">name</span> <span class="o">=</span> <span class="nx">pesudo</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
          <span class="nx">filter</span> <span class="o">=</span> <span class="nx">pesudoFilters</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;不支持的伪类:&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">pesudo</span><span class="p">.</span><span class="nx">param</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>attributes会分发到ExpandsFilter中的operator去处理</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">attributes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">operatorFilters</span> <span class="o">=</span> <span class="nx">expandFilters</span><span class="p">[</span><span class="s2">&quot;operators&quot;</span><span class="p">]</span>

      <span class="k">for</span> <span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">len</span><span class="p">],</span>
          <span class="nx">operator</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">[</span><span class="s2">&quot;operator&quot;</span><span class="p">],</span>
          <span class="nx">filter</span> <span class="o">=</span> <span class="nx">operatorFilters</span><span class="p">[</span><span class="nx">operator</span><span class="p">],</span>
          <span class="nx">nodeValue</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">nodeValue</span> <span class="o">===</span> <span class="kc">null</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">operator</span> <span class="o">!==</span> <span class="s2">&quot;!=&quot;</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span>
          <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">operator</span><span class="p">)</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;不支持的操作符:&quot;</span> <span class="o">+</span> <span class="nx">operator</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">filter</span><span class="p">(</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="o">+</span><span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <h2>expandFilters </h2>

<p>原生可扩展的方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">expandFilters</span> <span class="o">=</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p><strong>扩展连接符</strong>:
选择符filter 与其他filter不同 node 同样是当前节点 区别是
如果成功返回成功的上游节点(可能是父节点 可能是兄弟节点等等)
其中 match(node) 返回 这个上游节点是否匹配剩余选择符(内部仍是一个递归)</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">combos</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;&gt;&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nx">parent</span><span class="p">))</span> <span class="k">return</span> <span class="nx">parent</span>
      <span class="p">},</span>
      <span class="s2">&quot;~&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">prev</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="nx">prev</span><span class="p">))</span> <span class="k">return</span> <span class="nx">prev</span>
          <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s2">&quot; &quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">pass</span> <span class="o">=</span> <span class="nx">match</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pass</span><span class="p">)</span> <span class="k">return</span> <span class="nx">parent</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pass</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span>
          <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span>
      <span class="p">},</span>
      <span class="s2">&quot;+&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">prev</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">(</span><span class="nx">prev</span><span class="p">))</span> <span class="k">return</span> <span class="nx">prev</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p><strong>扩展操作符</strong> :</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">operators</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;^=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nodeValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="nx">nodeValue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="s2">&quot;=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">nodeValue</span> <span class="o">===</span> <span class="nx">value</span>
      <span class="p">},</span>
      <span class="s2">&quot;~=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nodeValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">nodeValue</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;$=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//以value结尾</span>
        <span class="k">return</span> <span class="nx">nodeValue</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">nodeValue</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">===</span> <span class="nx">value</span>
      <span class="p">},</span>
      <span class="s2">&quot;|=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 连接符</span>
        <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">nodeValue</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;*=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//出现在nodeValue的任意位置</span>
        <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="nx">nodeValue</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;!=&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">nodeValue</span> <span class="o">!==</span> <span class="nx">value</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p><strong>扩展伪类</strong>:</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">pesudos</span><span class="o">:</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>TODO:这里如果出自 SELECtorAPI 标注下处处</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="s2">&quot;not&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">matches</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;matches&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>child pesudo 统一由工厂函数生成</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="s2">&quot;nth-child&quot;</span><span class="o">:</span> <span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="s2">&quot;nth-last-child&quot;</span><span class="o">:</span> <span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="s2">&quot;nth-of-type&quot;</span><span class="o">:</span> <span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
      <span class="s2">&quot;nth-last-of-type&quot;</span><span class="o">:</span> <span class="nx">createNthFilter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
      <span class="s2">&quot;nth-match&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+of\s+/</span><span class="p">),</span>
          <span class="nx">nth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">sl</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
          <span class="nx">start</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">firstChild</span>

          <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">nes</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">sl</span><span class="p">))</span> <span class="nx">nth</span><span class="o">--</span>
          <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">nth</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">))</span>

          <span class="k">return</span> <span class="o">!</span><span class="nx">nth</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span> <span class="o">===</span> <span class="nx">start</span>
      <span class="p">},</span>
      <span class="s2">&quot;first-child&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;last-child&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;last-of-type&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;first-of-type&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;only-child&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;only-of-type&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">nthPrev</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nthNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span>
      <span class="p">},</span>
</pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>找出有具体text内容的节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="s2">&quot;contains&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">~</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="s2">&quot;checked&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!!</span><span class="nx">node</span><span class="p">.</span><span class="nx">checked</span> <span class="o">||</span> <span class="o">!!</span> <span class="nx">node</span><span class="p">.</span><span class="nx">selected</span>
      <span class="p">},</span>
      <span class="s2">&quot;selected&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">selected</span>
      <span class="p">},</span>
      <span class="s2">&quot;enabled&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">===</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="s2">&quot;disabled&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">===</span> <span class="kc">true</span>
      <span class="p">},</span>
      <span class="s2">&quot;empty&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">nodeType</span><span class="p">;</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">&gt;</span> <span class="s2">&quot;@&quot;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">nodeType</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span><span class="p">)</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">||</span> <span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">},</span>
      <span class="s2">&quot;focus&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span> <span class="o">===</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">hasFocus</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">hasFocus</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">href</span> <span class="o">||</span> <span class="o">~</span><span class="nx">node</span><span class="p">.</span><span class="nx">tabIndex</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="s2">&quot;target&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">name</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>这里主要是整合之前的ExpandsFilter中的mathch, 单层数据</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">matchDatum</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">datum</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">subFilter</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">datum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ignored</span> <span class="o">!==</span> <span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">subFilter</span> <span class="o">=</span> <span class="nx">filters</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">subFilter</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">datum</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>这个全局cache的引入是为了避免多次传入参数。
当然全局的缺点也很明显，维护会不方便, 不利于测试</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">matchesCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">//保存那些matches函数</span>
  <span class="kd">function</span> <span class="nx">matchData</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 稍后再看存入step</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">datum</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>首先要满足自身</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matchDatum</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">datum</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
        <span class="kd">var</span> <span class="nx">nextDatum</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span>
          <span class="nx">getNext</span> <span class="o">=</span> <span class="nx">expandFilters</span><span class="p">.</span><span class="nx">combos</span><span class="p">[</span><span class="nx">nextDatum</span><span class="p">.</span><span class="nx">combo</span><span class="p">],</span>
          <span class="nx">match</span> <span class="o">=</span> <span class="nx">matchesCache</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span>
          <span class="nx">next</span> <span class="o">=</span> <span class="nx">getNext</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">match</span><span class="p">)</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
          <span class="k">else</span> <span class="k">return</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>动态产生供FilterOneNode使用的match</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">createMatch</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">==</span> <span class="nx">root</span> <span class="o">||</span> <span class="nx">node</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">node</span> <span class="o">==</span> <span class="nx">doc</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span> <span class="c1">//null 相当于休止符</span>
        <span class="k">return</span> <span class="nx">matchData</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">createMatches</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">createMatch</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">matches</span>
    <span class="p">};</span>
</pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <h2>过滤主函数filter</h2>

<p>自底向上过滤非匹配节点</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
</pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>这里是为了缓存match匹配函数</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">preMatchesCache</span> <span class="o">=</span> <span class="nx">matchesCache</span>
      <span class="nx">matchesCache</span> <span class="o">=</span> <span class="nx">createMatches</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matchData</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">results</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Fixed: 因为一次filter可能会有字filter调用，比如matches、not、include</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">matchesCache</span> <span class="o">=</span> <span class="nx">preMatchesCache</span><span class="p">;</span> <span class="c1">// warning :以后写全局变量一定当心</span>
      <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>获得第一次目标节点集</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">getTargets</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">,</span> <span class="nx">lastPiece</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span> <span class="o">=</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byId</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">ignored</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">classList</span> <span class="o">&amp;&amp;</span> <span class="nx">lastPiece</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byClassName</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span> <span class="o">=</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byClassName</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">classList</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
        <span class="nx">ignored</span> <span class="o">=</span> <span class="s2">&quot;classList&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">results</span> <span class="o">=</span> <span class="nx">finders</span><span class="p">.</span><span class="nx">byTagName</span><span class="p">(</span><span class="nx">lastPiece</span><span class="p">.</span><span class="nx">tag</span> <span class="o">||</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
        <span class="nx">ignored</span> <span class="o">=</span> <span class="s2">&quot;tag&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ignored</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <h2>API : find (private)</h2>

<p>根据parse后的数据进行节点查找
options:
   1. parsed.data  parse数据为一数组
   2. node         context节点
事实上没有data这个单词，我这里算是自定了这个单词
    datas : [data,data] <br />
    data : [datum, datum]
    datum: {tag:"*"....etc}</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">return</span> <span class="p">[]</span>
      <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">datas</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">datas</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
          <span class="nx">dlen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">last</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
          <span class="nx">results</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">getTargets</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="nx">clearNthPositionCache</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
        <span class="nx">distinct</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortor</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">results</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <h2>API : 测试用get相当于all (private)</h2>

<p>为了测试时避免原生querySelector的影响</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">sl</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">find</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h2>API </h2>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">supportQuerySelector</span> <span class="o">=</span> <span class="o">!!</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">querySelector</span>

</pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>API1——<strong>one</strong>:对应标准的querySelector方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">one</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">supportQuerySelector</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nes</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">node</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">sl</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">node</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">node</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <h2>API2——<strong>all</strong></h2>

<p>对应标准的querySelectorAll方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">all</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nodeList</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">supportQuerySelector</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nes</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">nodeList</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span> <span class="o">||</span> <span class="nx">doc</span><span class="p">).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">sl</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">nodeList</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">nodeList</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">sl</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nodeList</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <h2>API 3: </h2>

<p>对应标准的matches方法
nes的matches功能稍强，它支持用分隔符链接符组合的复杂选择器
即与all、one函数的支持是一样的</p>

<p>注: 由于:not与:matches依赖于这个函数 ,所以同样支持复杂选择器</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">sl</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">datas</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">sl</span><span class="p">),</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">datas</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">datas</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">return</span> <span class="kc">false</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">len</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">matchOneData</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">datas</span><span class="p">[</span><span class="nx">len</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">true</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>matches 单步调用方法</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">matchOneData</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matchDatum</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">filter</span><span class="p">([</span><span class="nx">node</span><span class="p">],</span> <span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <h1>ASSEMBLE </h1>

<p>组装分为几个步骤</p>

<h2>1. 生成pesudo 、 operator、combo 等expand方法</h2>

<p>具体扩展方法的使用请参见 <a href="https://github.com/leeluolee/nes">nes的github</a></p>             </td>             <td class="code">               <div class="highlight"><pre>
    
</pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>统一由工厂函数createExpand</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">;(</span><span class="kd">function</span> <span class="nx">createExpand</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">beforeAssign</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">nes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">host</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>autoSet代表了这三个函数除了key、value参数
也支持字面量的参数输入</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">return</span> <span class="nx">autoSet</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Warning: 直接覆盖，如果存在的话</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="nx">container</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">container</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">beforeAssign</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">beforeAssign</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">})(</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>有些扩展如combos、operators由于为了避免冲突
关键字都写入了正则式中，这种情况下需要将新的正则式
填入相关正则，并进行parser的setup</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">})(</span><span class="nx">expandFilters</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;operators&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">befores</span> <span class="o">=</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">);</span>
      <span class="nx">befores</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">);</span>
      <span class="nx">macros</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="nx">befores</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="nx">parser</span><span class="p">.</span><span class="nx">setup</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s2">&quot;combos&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">befores</span> <span class="o">=</span> <span class="nx">macros</span><span class="p">.</span><span class="nx">combo</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">);</span>
      <span class="nx">befores</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">);</span>
      <span class="nx">macros</span><span class="p">.</span><span class="nx">combo</span> <span class="o">=</span> <span class="nx">befores</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="nx">parser</span><span class="p">.</span><span class="nx">setup</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">})</span>

</pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <h2>2. 暴露API</h2>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">extend</span><span class="p">(</span><span class="nx">nes</span><span class="p">,</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>直接设置其为true 来强制不适用原生querySelector Api</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">debug</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <h2>parser , 抽离的parser部分</h2>

<p>它可以:
   1. parser.parse 解析内部规则定义的字符串匹配
   2. parser.on    添加新规则
   3. parser.clone 复制此parser，这个作用会在后面的zen-coding的demo中体现
   4. parser.off   删除规则
   5. parser.cache 缓存控制</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">parser</span><span class="o">:</span><span class="nx">parser</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>解析, 这个将被移除，使用parser.parse来代替</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">parse</span><span class="o">:</span> <span class="nx">parse</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>查找parser解析后的data代表的节点 <strong>private</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">_find</span><span class="o">:</span> <span class="nx">find</span><span class="p">,</span>  
</pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>测试时排除原生querySelector的影响 <strong>deprecated</strong>! 使用nes.debug来控制</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">_get</span><span class="o">:</span> <span class="nx">get</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <h2>       <em>主要API</em></h2>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">one</span><span class="o">:</span> <span class="nx">one</span><span class="p">,</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">all</span><span class="p">,</span>
    <span class="nx">matches</span><span class="o">:</span> <span class="nx">matches</span>
</pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>内建扩展 api 这三个已经内建:</p>

<ol>
<li><code>pesudos</code></li>
<li><code>operators</code></li>
<li><code>combos</code></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">})</span>

</pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <h2>         5.Exports</h2>

<p>暴露API:  amd || commonjs  || global 
支持commonjs</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">nes</span><span class="p">;</span>
</pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>支持amd</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">nes</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>直接暴露到全局</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">win</span><span class="p">.</span><span class="nx">nes</span> <span class="o">=</span> <span class="nx">nes</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}(</span><span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 